CREATE TABLE MARKET_PLACE_USER
(
    ID        NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    PASSWORD  VARCHAR2(15) NOT NULL,
    ROLE      VARCHAR2(10) NOT NULL,
    ROLE_ID   VARCHAR2(20),
    USER_NAME VARCHAR2(30) NOT NULL
        CONSTRAINT UK_MP_USER_NAME UNIQUE,
    CONSTRAINT PK_MPU PRIMARY KEY (ID)
);

CREATE TABLE BRANDS
(
    BRAND_ID   VARCHAR2(20) NOT NULL,
    ADDRESS    VARCHAR2(120),
    BRAND_NAME VARCHAR2(30) NOT NULL
        CONSTRAINT UK_BRAND_NAME UNIQUE,
    JOIN_DATE  DATE NOT NULL,
    CONSTRAINT PK_BRANDS PRIMARY KEY (BRAND_ID)
);

CREATE TABLE LOYALTY_PROGRAM
(
    CODE      VARCHAR2(20) NOT NULL,
    NAME      VARCHAR2(30) NOT NULL,
    BRAND_ID  VARCHAR2(20) NOT NULL
        CONSTRAINT UK_LP_BRAND_ID UNIQUE,
    IS_TIERED NUMBER(1,0) DEFAULT 0,
    IS_VALIDATED NUMBER(1,0) DEFAULT 0,
    CONSTRAINT PK_LP_CODE PRIMARY KEY (CODE),
    CONSTRAINT FK_LP_BRAND_ID FOREIGN KEY (BRAND_ID) REFERENCES BRANDS(BRAND_ID) ON DELETE CASCADE
);

CREATE TABLE CUSTOMER
(
    CUSTOMER_ID VARCHAR2(20) NOT NULL,
    ADDRESS     VARCHAR2(100),
    NAME        VARCHAR2(30)  NOT NULL,
    PHONE       NUMBER(19)
        CONSTRAINT UK_CUSTOMER_PHONE UNIQUE,
    WALLET_ID   VARCHAR2(20)  NOT NULL
        CONSTRAINT UK_CUSTOMER_WALLET_ID UNIQUE,
    CONSTRAINT PK_CUSTOMER PRIMARY KEY (CUSTOMER_ID)
);

CREATE TABLE ENROLL_CUSTOMER
(
    CUSTOMER_ID    VARCHAR2(20) NOT NULL,
    LP_CODE        VARCHAR2(20) NOT NULL,
    CONSTRAINT PK_ENROLL PRIMARY KEY (CUSTOMER_ID, LP_CODE),
    CONSTRAINT FK_ENROLL_CID FOREIGN KEY (CUSTOMER_ID) REFERENCES CUSTOMER(CUSTOMER_ID) ON DELETE CASCADE ,
    CONSTRAINT FK_ENROLL_LPC FOREIGN KEY (LP_CODE) REFERENCES LOYALTY_PROGRAM(CODE) ON DELETE CASCADE
);

CREATE TABLE CUSTOMER_PROGRAM_STATUS
(
    WALLET_ID    VARCHAR2(20) NOT NULL,
    LP_CODE      VARCHAR2(20),
    TOTAL_POINTS NUMBER(19) NOT NULL,
    TIER_STATUS  VARCHAR2(20),
    CONSTRAINT PK_CPS PRIMARY KEY (WALLET_ID,LP_CODE),
    CONSTRAINT FK_CPS_WALLET_ID FOREIGN KEY (WALLET_ID) REFERENCES CUSTOMER(WALLET_ID) ON DELETE CASCADE,
    CONSTRAINT FK_CPS_LP_CODE FOREIGN KEY (LP_CODE) REFERENCES LOYALTY_PROGRAM(CODE) ON DELETE CASCADE
);

CREATE TABLE WALLET
(
    ID            NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY,
    WALLET_ID     VARCHAR2(20) NOT NULL,
    LP_CODE       VARCHAR2(20),
    CATEGORY      VARCHAR2(20) NOT NULL,
    ACTIVITY_NAME VARCHAR2(20) NOT NULL,
    RULE_CODE     VARCHAR2(10),
    POINTS        NUMBER(19) NOT NULL,
    "DATE"        TIMESTAMP NOT NULL,
    CONSTRAINT CHECK_WALLET_CATEGORY CHECK (CATEGORY IN ('REDEEM' , 'EARN', 'ENROLL')),
    CONSTRAINT PK_WALLET_ID PRIMARY KEY (ID),
    CONSTRAINT FK_WALLET_WALLET_ID FOREIGN KEY (WALLET_ID) REFERENCES CUSTOMER(WALLET_ID) ON DELETE CASCADE,
    CONSTRAINT FK_WALLET_CODE FOREIGN KEY (LP_CODE) REFERENCES LOYALTY_PROGRAM(CODE) ON DELETE SET NULL
);

CREATE TABLE REWARD_CATEGORY
(
    REWARD_ID   VARCHAR2(10) NOT NULL PRIMARY KEY,
    REWARD_NAME VARCHAR2(20) NOT NULL
        CONSTRAINT UK_REWARD_TYPE UNIQUE,
    CONSTRAINT UK_RC_ID_TYPE UNIQUE (REWARD_ID, REWARD_NAME)
);

CREATE TABLE ACTIVITY_CATEGORY
(
    ACTIVITY_ID   VARCHAR2(10) NOT NULL PRIMARY KEY,
    ACTIVITY_NAME VARCHAR2(20) NOT NULL
        CONSTRAINT UK_ACTIVITY_TYPE UNIQUE,
    CONSTRAINT UK_AC_ID_TYPE UNIQUE (ACTIVITY_ID, ACTIVITY_NAME)
);

CREATE TABLE REWARD
(
    LP_CODE     VARCHAR2(20) NOT NULL,
    REWARD_ID   VARCHAR2(10) NOT NULL,
    REWARD_NAME VARCHAR2(20) NOT NULL,
    CONSTRAINT PK_REWARD PRIMARY KEY (LP_CODE, REWARD_ID),
    CONSTRAINT FK_REWARD_LP_CODE FOREIGN KEY (LP_CODE) REFERENCES LOYALTY_PROGRAM(CODE) ON DELETE CASCADE,
    CONSTRAINT FK_REWARD_ID_TYPE FOREIGN KEY (REWARD_ID, REWARD_NAME) REFERENCES REWARD_CATEGORY(REWARD_ID, REWARD_NAME) ON DELETE CASCADE ,
    CONSTRAINT UK_REWARD_CODE_RTYPE UNIQUE (LP_CODE, REWARD_NAME)
);

CREATE TABLE ACTIVITY
(
    LP_CODE       VARCHAR2(20) NOT NULL,
    ACTIVITY_ID   VARCHAR2(10) NOT NULL,
    ACTIVITY_NAME VARCHAR2(20) NOT NULL,
    CONSTRAINT PK_ACTIVITY PRIMARY KEY (LP_CODE, ACTIVITY_ID),
    CONSTRAINT FK_ACTIVITY_LP_CODE FOREIGN KEY (LP_CODE) REFERENCES LOYALTY_PROGRAM(CODE) ON DELETE CASCADE ,
    CONSTRAINT FK_ACTIVITY_ID_TYPE FOREIGN KEY (ACTIVITY_ID, ACTIVITY_NAME) REFERENCES ACTIVITY_CATEGORY(ACTIVITY_ID, ACTIVITY_NAME) ON DELETE CASCADE ,
    CONSTRAINT UK_ACTIVITY_CODE_RTYPE UNIQUE (LP_CODE, ACTIVITY_NAME)
);

CREATE TABLE TIERS
(
    LP_CODE         VARCHAR2(20) NOT NULL,
    TIER_NAME       VARCHAR2(20) NOT NULL,
    "LEVEL"         INT NOT NULL,
    POINTS_REQUIRED NUMBER(10) NOT NULL,
    MULTIPLIER      INT NOT NULL,
    CONSTRAINT PK_TIERS PRIMARY KEY (LP_CODE, TIER_NAME),
    CONSTRAINT FK_TIERS_LP_CODE FOREIGN KEY (LP_CODE) REFERENCES LOYALTY_PROGRAM(CODE) ON DELETE CASCADE
);

CREATE TABLE RE_RULES
(
    RULE_CODE      VARCHAR2(10) NOT NULL ,
    LP_CODE        VARCHAR2(20) NOT NULL ,
    ACTIVITY_NAME  VARCHAR2(20) NOT NULL ,
    POINTS         NUMBER(10) NOT NULL ,
    VERSION        INT NOT NULL,
    CONSTRAINT FK_RER_ACTIVITY_NAME FOREIGN KEY (LP_CODE, ACTIVITY_NAME) REFERENCES ACTIVITY (LP_CODE, ACTIVITY_NAME) ON DELETE CASCADE
);

CREATE TABLE RR_RULES
(
    RULE_CODE    VARCHAR2(10) NOT NULL ,
    LP_CODE      VARCHAR2(20) NOT NULL ,
    REWARD_NAME  VARCHAR2(20) NOT NULL ,
    POINTS       NUMBER(10) NOT NULL ,
    INSTANCES    INT NOT NULL ,
    VERSION      INT NOT NULL ,
    CONSTRAINT FK_RRR_REWARD_NAME FOREIGN KEY (LP_CODE, REWARD_NAME) REFERENCES REWARD (LP_CODE, REWARD_NAME) ON DELETE CASCADE
);